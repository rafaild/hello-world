<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <title>Пример upload + register-upload</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    #status { margin-top: 1rem; color: darkred; }
    pre { background: #f4f4f4; padding: .5rem; }
  </style>
</head>
<body>
  <h1>Загрузить фото пользователя</h1>

  <!-- Введите ваш user_id (или получите его из localStorage) -->
  <label>
    User ID:
    <input type="text" id="userIdInput" placeholder="вставьте user_id" style="width: 300px"/>
  </label>
  <br/><br/>

  <!-- Выберите файл и нажмите "Загрузить" -->
  <input type="file" id="fileInput" accept="image/*"/>
  <button id="uploadBtn">Загрузить → register-upload</button>

  <div id="status"></div>

  <h2>Ответ от n8n + данные upload:</h2>
  <pre id="response">здесь будет JSON</pre>

  <script>
    (function(){
      // 1) Инициализируем Supabase client
      const { createClient } = window.supabase
      const supabaseClient = createClient(
        'https://tjspovgnqlmsgjdmvfnd.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRqc3BvdmducWxtc2dqZG12Zm5kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQyNDQwMTQsImV4cCI6MjA1OTgyMDAxNH0.l7VvqIl_tHvgslU9o4-7oqRxJFwzTXnZzUnMTGplz1E'
      );

      const shop_api_key = 'demo_test';  // или ваш реальный

      const statusDiv   = document.getElementById('status');
      const responsePre = document.getElementById('response');
      const fileInput   = document.getElementById('fileInput');
      const uploadBtn   = document.getElementById('uploadBtn');
      const userIdInput = document.getElementById('userIdInput');

      uploadBtn.onclick = async () => {
        statusDiv.textContent = '';
        responsePre.textContent = '';

        const user_id = userIdInput.value.trim();
        if (!user_id) {
          statusDiv.textContent = 'Error: укажите user_id';
          return;
        }

        if (!fileInput.files.length) {
          statusDiv.textContent = 'Error: выберите файл';
          return;
        }

        // 2) Формируем имена
        const file = fileInput.files[0];
        // чтобы не было коллизий, добавляем timestamp и user_id
        const changed_filename = `${user_id}_${Date.now()}_${file.name}`;
        const storage_path     = `user_images/${changed_filename}`;

        try {
          // 3) Upload в Supabase Storage
          const { data: uploadData, error: uploadErr } = await supabase
            .storage
            .from('store01')
            .upload(storage_path, file);

          if (uploadErr) throw uploadErr;

          // 4) Получаем publicUrl
          const { data: urlData, error: urlErr } = supabase
            .storage
            .from('store01')
            .getPublicUrl(storage_path);
          if (urlErr) throw urlErr;

          const storage_url = urlData.publicUrl;

          // 5) Собираем payload для n8n
          const payload = {
            user_id,
            original_filename: file.name,
            changed_filename,
            storage_path,
            storage_url,
            shop_api_key
          };

          // 6) POST в n8n
          const res = await fetch('https://saylolsay23.app.n8n.cloud/webhook-test/register-upload', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const json = await res.json();
          if (!res.ok) {
            throw new Error(json.message || JSON.stringify(json));
          }

          // 7) Выводим на экран полный JSON (payload + ответ n8n)
          const out = {
            ...payload,
            ...json
          };
          responsePre.textContent = JSON.stringify(out, null, 2);

        } catch (err) {
          console.error(err);
          statusDiv.textContent = 'Ошибка: ' + err.message;
        }
      };
    })();
  </script>
</body>
</html>
